var jsonFilesLoader = require('./load-json-files');

var db = {};

function search(array, fieldName, value){
  for (var i = 0; i < array.length; i++){
    var item = array[i];

    if (item[fieldName] == value){
      return item;
    }
  }
}

db.get = function(url){

    var split = url.split("/");
    split.splice(0, 1);
    var object;

    switch (split.length) {
      case 1:
        if (!db.data[split[0]]) throw 'pattern unknow';
        object = db.data[split[0]];
        break;
      case 2:
        object = search(db.data[split[0]], 'id', split[1]);
        break;
      case 3:
        if (!db.data[split[2]]) throw 'pattern unknow';
        var beforeLabel = split[0].substring(0, split[0].length - 1) + 'Id';
        object = db.data[split[2]].filter(function(item){
          return item[beforeLabel] == split[1];
        });
        break;
      case 4:
        var beforeLabel = split[0].substring(0, split[0].length - 1) + 'Id';
        console.log('beforeLabel', beforeLabel);
        object = search(db.data[split[2]], 'id', split[3]);

        if (object[beforeLabel] != split[1]){
          object = [];
        }

        break;
      default:
        var message = 'Depth no support!!!!!'
        console.error(message);
        throw message;
    }

    return object;
}

module.exports = function(path){
  return new Promise(function(resolve){
    jsonFilesLoader(path).then(function(data){
      db.data = data;
      console.log('data', data);
      resolve(db);
    });
  });
}
